# ğŸ§  OuvIoT â€“ Backend  


Esta parte do repositÃ³rio representa o **Backend (API REST)**, responsÃ¡vel por:
- Receber e armazenar dados de sensores enviados pelo ESP32 via MQTT
- Gerenciar usuÃ¡rios e autenticaÃ§Ã£o simples;
- Expor rotas REST para o aplicativo mobile e painel web
- Persistir informaÃ§Ãµes no MongoDB
- Fornecer endpoints para o painel web e aplicativo mobile.
- Controlar inÃ­cio e parada de captura
- Gerar alertas automÃ¡ticos
- Organizar salas, usuÃ¡rios e histÃ³rico de ruÃ­do

---

## âš™ï¸ Tecnologias Utilizadas

| Tecnologia | FunÃ§Ã£o |
|-------------|---------|
| **Node.js** | Ambiente de execuÃ§Ã£o do servidor |
| **Express.js** | CriaÃ§Ã£o das rotas da API |
| **MongoDB Atlas** | Banco de dados em nuvem |
| **Mongoose** | Modelagem dos dados e integraÃ§Ã£o com MongoDB |
| **dotenv** | VariÃ¡veis de ambiente e seguranÃ§a |
| **bcryptjs** | Criptografia de senhas |
| **CORS** | ComunicaÃ§Ã£o entre frontends e backend |
| **MQTT.js** | ComunicaÃ§Ã£o com ESP32 |
---

## ğŸ“¡ Fluxo Arquitetural â€“ OuvIoT
```
[Mobile] â€”â€”HTTPâ€”â€”> [Backend] â€”â€”MQTTâ€”â€”> [ESP32 + Sensor]
      <â€”HTTPâ€”â€”        <â€”MQTTâ€”â€”â€”
         â”‚                   â”‚
      GET dados           Envia dB
      POST iniciar        Envia status
      POST parar
```
Resumo do fluxo:
1. Mobile chama POST /captura/iniciar
2. Backend publica MQTT: "ouviot/captura/comando" â†’ "start"
3. ESP32 comeÃ§a a captar som e envia:
```    
    topic: ouviot/captura/dados
    payload: { sala, db, status }
```
4. Backend recebe os dados â†’ salva em SensorData
5. Se status = alert ou high â†’ salva em Alerta
6. Mobile consulta o grÃ¡fico chamando:
```
    GET /sensores/ultimos/:sala
```
---

## ğŸ§± Estrutura de Pastas

```
backend/
 â”œâ”€â”€ server.js
 â”œâ”€â”€ mqtt/
 â”‚    â””â”€â”€ client.js
 â”œâ”€â”€ models/
 â”‚    â”œâ”€â”€ Sala.js
 â”‚    â”œâ”€â”€ Usuario.js
 â”‚    â”œâ”€â”€ SensorData.js
 â”‚    â”œâ”€â”€ Alerta.js
 â”œâ”€â”€ controllers/
 â”‚    â”œâ”€â”€ salaController.js
 â”‚    â”œâ”€â”€ usuarioController.js
 â”‚    â”œâ”€â”€ authController.js
 â”‚    â”œâ”€â”€ sensorController.js
 â”‚    â”œâ”€â”€ alertaController.js
 â”œâ”€â”€ routes/
 â”‚    â”œâ”€â”€ auth.js
 â”‚    â”œâ”€â”€ salas.js
 â”‚    â”œâ”€â”€ usuarios.js
 â”‚    â”œâ”€â”€ sensores.js   â† **NOVA ROTA**
 â”‚    â”œâ”€â”€ captura.js
 â”‚    â”œâ”€â”€ alertas.js
 â””â”€â”€ .env

```
---
# ğŸ“¡ MQTT â€“ IntegraÃ§Ã£o com ESP32

### TÃ³picos Assinados
- `ouviot/captura/dados` â€“ ESP32 envia dados de ruÃ­do  
- `ouviot/captura/comando` â€“ comandos start/stop  
- `ouviot/captura/sala` â€“ sala ativa definida via app  

### Comandos enviados pelo Backend
- `"start"` â†’ iniciar captura  
- `"stop"` â†’ parar captura  
- `"nome-da-sala"` â†’ associar leitura Ã  sala correta  

---


### ğŸ”§ 1ï¸âƒ£ Instalar dependÃªncias
No terminal, dentro da pasta `backend`:
```bash
npm install
```

### ğŸŒ¿ 2ï¸âƒ£ Configurar variÃ¡veis de ambiente
Crie um arquivo chamado `.env` com:
```
MONGO_URI=mongodb+srv://usuario:senha@seucluster.mongodb.net/ouviot
PORT=5000
```

> âš ï¸ O `.env` estÃ¡ protegido pelo `.gitignore` e **nÃ£o deve ser versionado**.

### â–¶ï¸ 3ï¸âƒ£ Executar o servidor
```bash
npm start
```

Se tudo estiver correto:
```
âœ… Conectado ao MongoDB com sucesso!
ğŸš€ Servidor rodando na porta 5000
```


---

## ğŸ“¡ Endpoints Principais

## ğŸ‘¤ UsuÃ¡rios
| MÃ©todo | Rota | DescriÃ§Ã£o |
|-------|------|-----------|
| POST | `/usuarios` | Criar usuÃ¡rio |
| GET | `/usuarios` | Listar usuÃ¡rios |
| DELETE | `/usuarios/:email` | Remover usuÃ¡rio |

## ğŸ” AutenticaÃ§Ã£o
| MÃ©todo | Rota | DescriÃ§Ã£o |
|-------|------|-----------|
| POST | `/auth/login` | Login do usuÃ¡rio |

Exemplo de corpo:
```json
{
  "email": "mo@ouviot.com",
  "senha": "123456"
}
```
## ğŸ« Salas
| MÃ©todo | Rota | DescriÃ§Ã£o |
|-------|------|-----------|
| GET | `/salas` | Listar salas |
| POST | `/salas` | Criar nova sala |
| DELETE | `/salas/:nome` | Remover sala |

---

## ğŸ“Š Dados do Sensor â€“ Para o grÃ¡fico
| MÃ©todo | Rota | DescriÃ§Ã£o |
|-------|------|-----------|
| GET | `/sensores/ultimos/:sala` | Retorna os Ãºltimos 20 valores de dB da sala |

---

## ğŸ“¡ Captura (Mobile â†’ Backend â†’ ESP32 via MQTT)
| MÃ©todo | Rota | DescriÃ§Ã£o |
|-------|------|-----------|
| POST | `/captura/iniciar` | Inicia a captura de ruÃ­do |
| POST | `/captura/parar` | Para a captura |
| POST | `/captura/selecionar-sala` | Define a sala ativa |

---

## ğŸš¨ Alertas
| MÃ©todo | Rota | DescriÃ§Ã£o |
|-------|------|-----------|
| GET | `/alertas` | Lista alertas gerais |
| GET | `/alertas/sala/:sala` | Lista alertas da sala |

---

## ğŸ” AutenticaÃ§Ã£o Simples
O backend realiza login bÃ¡sico comparando o e-mail e senha criptografada via **bcrypt**.  
ApÃ³s o login, o frontend/mobile pode armazenar os dados do usuÃ¡rio logado (`id`, `nome`, `tipo`) em:
- `localStorage` (versÃ£o Web)
- `AsyncStorage` (versÃ£o Mobile)

Exemplo de resposta:
```json
{
  "message": "Login realizado com sucesso!",
  "usuario": {
    "id": "6713f8c3...",
    "nome": "Mo Dev",
    "email": "mo@ouviot.com",
  }
}
```

